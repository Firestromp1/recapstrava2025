<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Ann√©e Sportive 2025 - Strava</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 20%, #16213e 50%, #0f2027 80%, #000 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(252, 76, 2, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 215, 0, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 107, 53, 0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .strava-logo {
            text-align: center;
            padding: 30px 0;
        }

        .strava-logo svg {
            width: 120px;
            height: auto;
        }

        .card {
            background: linear-gradient(135deg, rgba(30, 30, 40, 0.95) 0%, rgba(20, 20, 30, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(252, 76, 2, 0.1) 0%, transparent 70%);
            animation: glow 8s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes glow {
            0%, 100% { transform: translate(0, 0); opacity: 0.3; }
            50% { transform: translate(20px, 20px); opacity: 0.6; }
        }

        .card-content {
            position: relative;
            z-index: 1;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 30px;
            text-align: center;
        }

        .flame-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
        }

        .flame-badge {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 20px;
        }

        .flame-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 6px solid #fc4c02;
            animation: spin 20s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .flame-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            background: linear-gradient(135deg, #fc4c02 0%, #ff6b35 100%);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 60px rgba(252, 76, 2, 0.6);
        }

        .flame-icon {
            font-size: 48px;
            margin-bottom: 5px;
        }

        .flame-number {
            font-size: 64px;
            font-weight: 700;
            line-height: 1;
        }

        .flame-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 5px;
        }

        .date-range {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin: 15px 0;
        }

        .week-dots {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-top: 25px;
            max-width: 400px;
        }

        .week-dot {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            background: rgba(252, 76, 2, 0.15);
            border: 2px solid rgba(252, 76, 2, 0.3);
            transition: all 0.3s;
        }

        .week-dot.active {
            background: #fc4c02;
            border-color: #fc4c02;
            box-shadow: 0 0 15px rgba(252, 76, 2, 0.8);
        }

        .stat-hero {
            text-align: center;
            margin: 40px 0;
        }

        .stat-value {
            font-size: 80px;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #fff 0%, #fc4c02 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 18px;
            color: #999;
            margin-top: 10px;
        }

        .month-chart {
            margin-top: 30px;
        }

        .month-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .month-label {
            width: 65px;
            font-size: 13px;
            font-weight: 700;
            color: #ffd700;
        }

        .month-bar-bg {
            flex: 1;
            height: 36px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 18px;
            overflow: hidden;
        }

        .month-bar {
            height: 100%;
            background: linear-gradient(90deg, #fc4c02, #ffd700);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            font-weight: 700;
            font-size: 15px;
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .trophy-showcase {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .trophy-card {
            background: linear-gradient(135deg, #fc4c02 0%, #ff6b35 100%);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(252, 76, 2, 0.4);
        }

        .trophy-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .trophy-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .trophy-time {
            font-size: 20px;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .stat-box {
            background: rgba(252, 76, 2, 0.1);
            border: 1px solid rgba(252, 76, 2, 0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .stat-box-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-box-value {
            font-size: 32px;
            font-weight: 700;
            color: #fc4c02;
        }

        .stat-box-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .achievement-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ff6b35 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .achievement-icon {
            font-size: 48px;
        }

        .achievement-text {
            flex: 1;
        }

        .achievement-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 14px;
            opacity: 0.9;
        }

        .time-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .time-label {
            width: 100px;
            font-size: 14px;
            color: #999;
        }

        .time-bar-fill {
            flex: 1;
            height: 8px;
            background: rgba(252, 76, 2, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .time-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #fc4c02, #ffd700);
            border-radius: 4px;
        }

        .time-value {
            width: 50px;
            text-align: right;
            font-weight: 700;
            font-size: 14px;
            margin-left: 10px;
        }

        .footer-brand {
            background: linear-gradient(90deg, #fc4c02 0%, #ffd700 50%, #fc4c02 100%);
            padding: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 1.5px;
            border-radius: 12px;
            margin-top: 25px;
            color: #000;
        }

        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(252, 76, 2, 0.2);
            border-top-color: #fc4c02;
            border-radius: 50%;
            animation: rotate 1s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes rotate {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fc4c02, #ffd700);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .btn {
            background: linear-gradient(135deg, #fc4c02 0%, #ff6b35 100%);
            color: white;
            padding: 18px 40px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(252, 76, 2, 0.5);
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(252, 76, 2, 0.7);
        }

        .login-card {
            text-align: center;
            padding: 60px 40px;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            background: #fc4c02;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            margin: 0 auto 30px;
        }

        .info-box {
            background: rgba(252, 76, 2, 0.1);
            border: 1px solid rgba(252, 76, 2, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            text-align: left;
        }

        .info-box strong {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box p {
            font-size: 14px;
            line-height: 1.6;
            color: #ccc;
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: left;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid rgba(252, 76, 2, 0.3);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #fc4c02;
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .card { padding: 30px 20px; }
            .flame-badge { width: 160px; height: 160px; }
            .flame-inner { width: 130px; height: 130px; }
            .flame-number { font-size: 48px; }
            .stat-value { font-size: 60px; }
            .trophy-showcase, .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        class StravaApp {
            constructor() {
                this.clientId = null;
                this.clientSecret = null;
                this.accessToken = null;
                this.activities = [];
                this.athlete = null;
                this.stats = {};
                this.app = document.getElementById('app');
                this.init();
            }

            async init() {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                const state = params.get('state');

                if (code && state) {
                    try {
                        const config = JSON.parse(atob(state));
                        this.clientId = config.clientId;
                        this.clientSecret = config.clientSecret;
                        await this.exchangeToken(code);
                    } catch(e) {
                        this.showError("Erreur de configuration");
                    }
                } else {
                    this.showSetup();
                }
            }

            showSetup() {
                this.app.innerHTML = `
                    <div class="card">
                        <div class="card-content">
                            <div class="login-card">
                                <div class="login-logo">S</div>
                                <h2 style="margin-bottom: 15px; font-size: 28px;">Configuration Strava</h2>
                                <p style="margin-bottom: 30px; color: #999;">Entre tes identifiants API</p>
                                
                                <div class="input-group">
                                    <label>Client ID</label>
                                    <input type="text" id="clientId" placeholder="Ex: 123456">
                                </div>
                                
                                <div class="input-group">
                                    <label>Client Secret</label>
                                    <input type="text" id="clientSecret" placeholder="Ex: abc123...">
                                </div>

                                <button onclick="app.saveConfig()" class="btn" style="margin-top: 20px;">
                                    Se connecter
                                </button>

                                <div class="info-box" style="margin-top: 30px;">
                                    <strong>O√π trouver ces infos ?</strong>
                                    <p>1. Va sur strava.com/settings/api<br>2. Cr√©e une application<br>3. Copie ton Client ID et Client Secret</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            saveConfig() {
                const clientId = document.getElementById('clientId').value.trim();
                const clientSecret = document.getElementById('clientSecret').value.trim();

                if (!clientId || !clientSecret) {
                    alert('Remplis tous les champs');
                    return;
                }

                this.clientId = clientId;
                this.clientSecret = clientSecret;

                const state = btoa(JSON.stringify({ clientId, clientSecret }));
                const authUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&approval_prompt=force&scope=read,activity:read_all&state=${state}`;
                window.location.href = authUrl;
            }

            async exchangeToken(code) {
                this.showLoading('Authentification...', 10);
                
                try {
                    const res = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: this.clientId,
                            client_secret: this.clientSecret,
                            code: code,
                            grant_type: 'authorization_code'
                        })
                    });

                    const data = await res.json();
                    this.accessToken = data.access_token;
                    this.athlete = data.athlete;
                    
                    window.history.replaceState({}, '', window.location.pathname);
                    await this.loadActivities();
                } catch (err) {
                    this.showError("Erreur d'authentification");
                }
            }

            async loadActivities() {
                this.showLoading('Chargement...', 20);

                try {
                    const after = Math.floor(new Date('2025-01-01').getTime() / 1000);
                    let page = 1, all = [];
                    
                    while (true) {
                        const url = `https://www.strava.com/api/v3/athlete/activities?after=${after}&page=${page}&per_page=200`;
                        const res = await fetch(url, { headers: { 'Authorization': `Bearer ${this.accessToken}` }});
                        const acts = await res.json();
                        
                        if (acts.length === 0) break;
                        all = all.concat(acts);
                        this.showLoading(`${all.length} activit√©s`, Math.min(90, 20 + page * 10));
                        
                        if (acts.length < 200) break;
                        page++;
                        await new Promise(r => setTimeout(r, 500));
                    }

                    this.activities = all;
                    if (all.length === 0) {
                        this.showError('Aucune activit√© en 2025');
                        return;
                    }

                    await this.calculateStats();
                    this.displayStats();
                } catch (err) {
                    this.showError(err.message);
                }
            }

            async calculateStats() {
                const stats = {
                    total: this.activities.length,
                    distance: 0, time: 0, elevation: 0, kudos: 0, calories: 0,
                    achievementCount: 0, prCount: 0, sports: {}, months: {},
                    days: new Set(), dayOfWeek: [0,0,0,0,0,0,0],
                    timeOfDay: { morning: 0, afternoon: 0, evening: 0, night: 0 },
                    longestActivity: null, fastestActivity: null,
                    highestElevation: null, mostKudos: null,
                    avgSpeed: 0, avgHeartRate: 0,
                    speedActivities: 0, heartRateActivities: 0,
                    commutes: 0, workouts: 0,
                    topSupporters: [],
                    weather: { rain: 0, cold: 0, hot: 0, wind: 0 },
                    cities: {}
                };

                const months = ['JAN', 'F√âV', 'MAR', 'AVR', 'MAI', 'JUIN', 'JUIL', 'AO√õT', 'SEPT', 'OCT', 'NOV', 'D√âC'];
                months.forEach(m => stats.months[m] = 0);

                this.activities.forEach(a => {
                    stats.distance += a.distance / 1000;
                    stats.time += a.moving_time / 3600;
                    stats.elevation += a.total_elevation_gain || 0;
                    stats.kudos += a.kudos_count || 0;
                    stats.achievementCount += a.achievement_count || 0;
                    stats.prCount += a.pr_count || 0;
                    
                    // Conditions m√©t√©o (bas√©es sur temp√©rature r√©elle)
                    const temp = a.average_temp;
                    if (temp !== undefined && temp !== null) {
                        if (temp < 5) stats.weather.cold++;
                        if (temp > 30) stats.weather.hot++;
                    }
                    
                    // D√©tection pluie/vent via analyse intelligente
                    const text = `${a.name || ''} ${a.description || ''}`.toLowerCase();
                    const rainKeywords = ['pluie', 'rain', 'wet', 'mouill√©', 'humide', 'drizzle', 'shower'];
                    const windKeywords = ['vent', 'wind', 'windy', 'venteux', 'breezy', 'gale'];
                    
                    if (rainKeywords.some(kw => text.includes(kw))) stats.weather.rain++;
                    if (windKeywords.some(kw => text.includes(kw))) stats.weather.wind++;
                    
                    // Si weather_type existe dans l'API (certaines versions)
                    if (a.weather && a.weather.includes('rain')) stats.weather.rain++;
                    if (a.weather && a.weather.includes('wind')) stats.weather.wind++;
                    
                    // Villes visit√©es - identification plus pr√©cise
                    let cityName = 'Ville inconnue';
                    
                    // Priorit√© 1: nom de la ville directement
                    if (a.location_city && a.location_city.trim()) {
                        cityName = a.location_city.trim();
                    } 
                    // Priorit√© 2: extraction depuis timezone
                    else if (a.timezone) {
                        const parts = a.timezone.split('/');
                        if (parts.length > 1) {
                            cityName = parts[parts.length - 1].replace(/_/g, ' ');
                        }
                    }
                    // Priorit√© 3: extraction depuis le nom de l'activit√©
                    else if (a.name) {
                        const matches = a.name.match(/√†\s+([A-Z√Ä-≈∏][a-z√†-√ø]+(?:\s+[A-Z√Ä-≈∏][a-z√†-√ø]+)*)/);
                        if (matches && matches[1]) {
                            cityName = matches[1];
                        }
                    }
                    
                    if (a.start_latlng && a.start_latlng.length === 2) {
                        // Cl√© bas√©e sur coordonn√©es arrondies (zone de ~1km)
                        const latKey = Math.round(a.start_latlng[0] * 100) / 100;
                        const lngKey = Math.round(a.start_latlng[1] * 100) / 100;
                        const cityKey = `${latKey},${lngKey}`;
                        
                        if (!stats.cities[cityKey]) {
                            stats.cities[cityKey] = {
                                name: cityName,
                                count: 0,
                                latlng: [latKey, lngKey]
                            };
                        } else {
                            // Mise √† jour du nom si on a un meilleur nom
                            if (cityName !== 'Ville inconnue' && stats.cities[cityKey].name === 'Ville inconnue') {
                                stats.cities[cityKey].name = cityName;
                            }
                        }
                        stats.cities[cityKey].count++;
                    }
                    
                    // Calories
                    if (a.kilojoules && a.kilojoules > 0) {
                        stats.calories += a.kilojoules * 0.239;
                    } else {
                        const type = a.sport_type || a.type;
                        if (type === 'Run' || type === 'Walk' || type === 'Hike') {
                            stats.calories += (a.distance / 1000) * 50;
                        } else if (type === 'Ride') {
                            stats.calories += (a.distance / 1000) * 30;
                        } else {
                            stats.calories += (a.distance / 1000) * 40;
                        }
                    }
                    
                    if (a.average_speed > 0) {
                        stats.avgSpeed += a.average_speed;
                        stats.speedActivities++;
                    }
                    if (a.average_heartrate > 0) {
                        stats.avgHeartRate += a.average_heartrate;
                        stats.heartRateActivities++;
                    }
                    if (a.commute) stats.commutes++;
                    if (a.workout_type) stats.workouts++;
                    
                    const date = new Date(a.start_date);
                    stats.days.add(date.toISOString().split('T')[0]);
                    stats.dayOfWeek[date.getDay()]++;
                    
                    const hour = date.getHours();
                    if (hour >= 5 && hour < 12) stats.timeOfDay.morning++;
                    else if (hour >= 12 && hour < 17) stats.timeOfDay.afternoon++;
                    else if (hour >= 17 && hour < 22) stats.timeOfDay.evening++;
                    else stats.timeOfDay.night++;
                    
                    const type = this.sportName(a.sport_type || a.type);
                    if (!stats.sports[type]) {
                        stats.sports[type] = {
                            count: 0, distance: 0, time: 0, elevation: 0,
                            icon: this.sportIcon(type)
                        };
                    }
                    
                    stats.sports[type].count++;
                    stats.sports[type].distance += a.distance / 1000;
                    stats.sports[type].time += a.moving_time / 3600;
                    stats.sports[type].elevation += a.total_elevation_gain || 0;
                    
                    stats.months[months[date.getMonth()]]++;
                    
                    if (!stats.longestActivity || a.distance > stats.longestActivity.distance) {
                        stats.longestActivity = a;
                    }
                    if (!stats.fastestActivity || (a.average_speed || 0) > (stats.fastestActivity.average_speed || 0)) {
                        stats.fastestActivity = a;
                    }
                    if (!stats.highestElevation || (a.total_elevation_gain || 0) > (stats.highestElevation.total_elevation_gain || 0)) {
                        stats.highestElevation = a;
                    }
                    if (!stats.mostKudos || (a.kudos_count || 0) > (stats.mostKudos.kudos_count || 0)) {
                        stats.mostKudos = a;
                    }
                });

                if (stats.speedActivities > 0) {
                    stats.avgSpeed = (stats.avgSpeed / stats.speedActivities) * 3.6;
                }
                if (stats.heartRateActivities > 0) {
                    stats.avgHeartRate = Math.round(stats.avgHeartRate / stats.heartRateActivities);
                }

                await this.analyzeTopSupporters(stats);
                this.stats = stats;
            }

            async analyzeTopSupporters(stats) {
                const supporterCounts = {};
                
                this.activities.forEach(a => {
                    if (a.kudos_count > 0 && a.id) {
                        if (!supporterCounts._activities) supporterCounts._activities = [];
                        supporterCounts._activities.push(a.id);
                    }
                });
                
                const sampleActivities = (supporterCounts._activities || [])
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 50);
                
                this.showLoading(`Analyse des supporters... 0/${sampleActivities.length}`, 90);
                
                for (let i = 0; i < sampleActivities.length; i++) {
                    const actId = sampleActivities[i];
                    try {
                        const res = await fetch(`https://www.strava.com/api/v3/activities/${actId}/kudos`, {
                            headers: { 'Authorization': `Bearer ${this.accessToken}` }
                        });
                        const kudoers = await res.json();
                        
                        kudoers.forEach(person => {
                            const key = person.id || `${person.firstname}_${person.lastname}`;
                            if (!supporterCounts[key]) {
                                supporterCounts[key] = {
                                    count: 0,
                                    firstname: person.firstname,
                                    lastname: person.lastname,
                                    profile: person.profile || person.profile_medium || ''
                                };
                            }
                            supporterCounts[key].count++;
                        });
                        
                        if ((i + 1) % 5 === 0) {
                            this.showLoading(`Analyse des supporters... ${i + 1}/${sampleActivities.length}`, 90 + Math.floor((i / sampleActivities.length) * 8));
                        }
                        
                        await new Promise(r => setTimeout(r, 80));
                    } catch (e) {
                        console.error('Erreur kudos:', e);
                    }
                }
                
                delete supporterCounts._activities;
                
                stats.topSupporters = Object.values(supporterCounts)
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 3);
            }

            sportName(type) {
                const map = {
                    'Run': 'Course', 'Ride': 'V√©lo', 'Walk': 'Marche',
                    'Hike': 'Randonn√©e', 'Swim': 'Natation', 'AlpineSki': 'Ski',
                    'NordicSki': 'Ski de fond', 'Workout': 'Musculation',
                    'Yoga': 'Yoga', 'WeightTraining': 'Musculation'
                };
                return map[type] || type;
            }

            sportIcon(type) {
                const icons = {
                    'Course': 'üëü', 'V√©lo': 'üö¥', 'Marche': 'üö∂',
                    'Randonn√©e': 'ü•æ', 'Natation': 'üèä', 'Ski': '‚õ∑Ô∏è',
                    'Ski de fond': '‚õ∑Ô∏è', 'Musculation': 'üí™', 'Yoga': 'üßò'
                };
                return icons[type] || '‚ö°';
            }

            calculateStreak() {
                if (this.activities.length === 0) return { weeks: 0 };

                const getWeekKey = (date) => {
                    const d = new Date(date);
                    const day = d.getDay();
                    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(d.setDate(diff));
                    monday.setHours(0, 0, 0, 0);
                    return monday.getTime();
                };

                const weeks = new Set();
                this.activities.forEach(a => weeks.add(getWeekKey(a.start_date)));

                const sortedWeeks = Array.from(weeks).sort((a, b) => a - b);
                if (sortedWeeks.length === 0) return { weeks: 0 };

                let maxStreak = 1, currentStreak = 1;
                let maxStart = 0, maxEnd = 0, currentStart = 0;
                const weekMs = 7 * 24 * 60 * 60 * 1000;

                for (let i = 1; i < sortedWeeks.length; i++) {
                    if (sortedWeeks[i] - sortedWeeks[i-1] === weekMs) {
                        currentStreak++;
                    } else {
                        if (currentStreak > maxStreak) {
                            maxStreak = currentStreak;
                            maxStart = currentStart;
                            maxEnd = i - 1;
                        }
                        currentStreak = 1;
                        currentStart = i;
                    }
                }

                if (currentStreak > maxStreak) {
                    maxStreak = currentStreak;
                    maxStart = currentStart;
                    maxEnd = sortedWeeks.length - 1;
                }

                return { 
                    weeks: maxStreak,
                    start: new Date(sortedWeeks[maxStart]),
                    end: new Date(sortedWeeks[maxEnd])
                };
            }

            formatDate(d) {
                return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
            }

            displayStats() {
                const topSports = Object.entries(this.stats.sports)
                    .sort((a,b) => b[1].distance - a[1].distance)
                    .slice(0, 3);

                const streak = this.calculateStreak();
                const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
                const maxDayCount = Math.max(...this.stats.dayOfWeek);
                
                const achievements = [];
                if (this.stats.distance >= 1000) achievements.push({ icon: 'üèÜ', title: 'Marathonien', desc: `Plus de 1000 km !` });
                if (this.stats.days.size >= 100) achievements.push({ icon: 'üî•', title: 'R√©gularit√©', desc: `${this.stats.days.size} jours actifs` });
                if (this.stats.elevation >= 10000) achievements.push({ icon: '‚õ∞Ô∏è', title: 'Grimpeur', desc: `${Math.round(this.stats.elevation)}m !` });

                this.app.innerHTML = `
                    ${this.athlete ? `
                    <div class="card">
                        <div class="card-content">
                            <div style="text-align: center;">
                                <h2 style="font-size: 32px; margin-bottom: 10px;">${this.athlete.firstname} ${this.athlete.lastname}</h2>
                                <p style="color: #999;">${this.athlete.city || ''} ${this.athlete.country || ''}</p>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <div class="stat-box-icon">üèÉ</div>
                                    <div class="stat-box-value">${this.stats.total}</div>
                                    <div class="stat-box-label">Activit√©s</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-box-icon">üëç</div>
                                    <div class="stat-box-value">${this.stats.kudos}</div>
                                    <div class="stat-box-label">Kudos</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-box-icon">üî•</div>
                                    <div class="stat-box-value">${Math.round(this.stats.calories)}</div>
                                    <div class="stat-box-label">Calories</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-box-icon">üèÖ</div>
                                    <div class="stat-box-value">${this.stats.achievementCount}</div>
                                    <div class="stat-box-label">Troph√©es</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">‚òÅÔ∏è M√©t√©o - Tes conditions extr√™mes</div>
                            <div style="text-align: center; margin: 20px 0; color: #999;">
                                Temp√™te ? Parfait, √ßa fera plus de kudos üß°
                            </div>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <div class="stat-box-icon">üåßÔ∏è</div>
                                    <div class="stat-box-value">${this.stats.weather.rain}</div>
                                    <div class="stat-box-label">sorties sous la pluie</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-box-icon">‚ùÑÔ∏è</div>
                                    <div class="stat-box-value">${this.stats.weather.cold}</div>
                                    <div class="stat-box-label">sorties dans le froid</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-box-icon">‚òÄÔ∏è</div>
                                    <div class="stat-box-value">${this.stats.weather.hot}</div>
                                    <div class="stat-box-label">sorties sous la chaleur</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-box-icon">üí®</div>
                                    <div class="stat-box-value">${this.stats.weather.wind}</div>
                                    <div class="stat-box-label">sorties face au vent</div>
                                </div>
                            </div>
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>

                    ${Object.keys(this.stats.cities).length > 0 ? `
                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">üß≠ Exploration - Tes terrains de jeu</div>
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 18px; color: #999;">Tu as couru dans <strong style="color: #fc4c02;">${Object.keys(this.stats.cities).length}</strong> villes cette ann√©e !</div>
                                <div style="font-size: 14px; color: #999; margin-top: 10px;">J'esp√®re que tu as partag√© tes bonnes adresses √† tes potes üòä</div>
                            </div>
                            <div style="margin-top: 30px;">
                                ${Object.entries(this.stats.cities)
                                    .sort((a, b) => b[1].count - a[1].count)
                                    .slice(0, 5)
                                    .map(([key, city], i) => {
                                        const maxCount = Object.values(this.stats.cities).reduce((max, c) => Math.max(max, c.count), 0);
                                        const percentage = (city.count / maxCount) * 100;
                                        return `
                                            <div style="margin-bottom: 20px;">
                                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                                    <div style="width: 40px; font-size: 20px; font-weight: 700; color: ${i === 0 ? '#ffd700' : '#999'};">${i === 0 ? '#1' : ''}</div>
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 16px; font-weight: 700; color: white; margin-bottom: 4px;">üìç ${city.name}</div>
                                                        <div style="font-size: 14px; color: #999;">${city.count} sorties</div>
                                                    </div>
                                                </div>
                                                <div style="height: 8px; background: rgba(252, 76, 2, 0.2); border-radius: 4px; overflow: hidden; margin-left: 40px;">
                                                    <div style="height: 100%; width: ${percentage}%; background: linear-gradient(90deg, #fc4c02, #ffd700); border-radius: 4px; transition: width 1s ease;"></div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                            ${Object.entries(this.stats.cities).sort((a, b) => b[1].count - a[1].count)[0] ? `
                            <div style="margin-top: 30px; text-align: center; padding: 20px; background: rgba(252, 76, 2, 0.1); border-radius: 16px; border: 1px solid rgba(252, 76, 2, 0.3);">
                                <div style="font-size: 14px; color: #999; margin-bottom: 5px;">Ta ville pr√©f√©r√©e</div>
                                <div style="font-size: 24px; font-weight: 700; color: #fc4c02;">
                                    ${Math.round((Object.entries(this.stats.cities).sort((a, b) => b[1].count - a[1].count)[0][1].count / this.stats.total) * 100)}% de tes sorties ont commenc√© √† ${Object.entries(this.stats.cities).sort((a, b) => b[1].count - a[1].count)[0][1].name} ‚ù§Ô∏è
                                </div>
                            </div>
                            ` : ''}
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>
                    ` : ''}

                    ${this.stats.topSupporters && this.stats.topSupporters.length > 0 ? `
                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">Tes plus grands supporters</div>
                            <div style="margin: 30px 0;">
                                ${this.stats.topSupporters.map((supporter, i) => {
                                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                                    const colors = [
                                        'linear-gradient(135deg, #ffd700 0%, #ff6b35 100%)',
                                        'linear-gradient(135deg, #c0c0c0 0%, #808080 100%)',
                                        'linear-gradient(135deg, #cd7f32 0%, #8b4513 100%)'
                                    ];
                                    return `
                                        <div style="background: ${colors[i]}; border-radius: 20px; padding: 25px; margin-bottom: ${i === 2 ? '0' : '20px'}; display: flex; align-items: center; gap: 20px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);">
                                            <div style="font-size: 48px;">${medals[i]}</div>
                                            <div style="flex: 1;">
                                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">${supporter.firstname} ${supporter.lastname}</div>
                                                <div style="font-size: 16px; opacity: 0.9;">üëç ${supporter.count} kudos</div>
                                            </div>
                                            <div style="font-size: 32px; font-weight: 700; color: rgba(255, 255, 255, 0.3);">#${i+1}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div style="text-align: center; color: #999; margin-top: 20px;">
                                Bas√© sur un √©chantillon de 50 activit√©s
                            </div>
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">Plus longue s√©rie</div>
                            <div class="flame-container">
                                <div class="flame-badge">
                                    <div class="flame-ring"></div>
                                    <div class="flame-inner">
                                        <div class="flame-icon">üî•</div>
                                        <div class="flame-number">${streak.weeks}</div>
                                        <div class="flame-label">SEMAINES</div>
                                    </div>
                                </div>
                                ${streak.start ? `<div class="date-range">${this.formatDate(streak.start)} - ${this.formatDate(streak.end)}</div>` : ''}
                                <div class="week-dots">
                                    ${Array(40).fill(0).map((_, i) => `<div class="week-dot ${i < streak.weeks ? 'active' : ''}"></div>`).join('')}
                                </div>
                            </div>
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>

                    ${achievements.length > 0 ? `
                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">Accomplissements</div>
                            ${achievements.map(a => `
                                <div class="achievement-badge">
                                    <div class="achievement-icon">${a.icon}</div>
                                    <div class="achievement-text">
                                        <div class="achievement-title">${a.title}</div>
                                        <div class="achievement-desc">${a.desc}</div>
                                    </div>
                                </div>
                            `).join('')}
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">Sports les plus pratiqu√©s</div>
                            <div style="position: relative; padding: 50px 0; background: linear-gradient(180deg, rgba(13, 50, 56, 0.6) 0%, rgba(0, 128, 128, 0.3) 50%, rgba(13, 50, 56, 0.6) 100%); border-radius: 20px; margin: 20px 0;">
                                ${topSports.map(([name, data], i) => {
                                    const max = topSports[0][1].distance;
                                    const percent = (data.distance / max) * 100;
                                    const heights = [150, 120, 90];
                                    return `
                                        <div style="position: relative; margin-bottom: ${i === 2 ? '0' : '40px'};">
                                            <div style="position: absolute; left: 20px; top: 20px; font-size: 20px; font-weight: 700; color: rgba(0, 200, 200, 0.7); z-index: 2;">${i+1}</div>
                                            <div style="position: relative; height: ${heights[i]}px; border-radius: 30px; overflow: hidden; background: linear-gradient(90deg, rgba(0, 200, 200, 0.4) 0%, rgba(0, 150, 150, 0.6) 50%, rgba(0, 100, 100, 0.8) 100%); width: ${percent}%; min-width: 250px; margin: 0 auto; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(0, 200, 200, 0.3); border: 1px solid rgba(0, 200, 200, 0.3);">
                                                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.2;" viewBox="0 0 100 100" preserveAspectRatio="none">
                                                    <path d="M0,0 Q25,${50 + i * 5} 50,${30 + i * 3} T100,0 L100,100 L0,100 Z" fill="rgba(0, 255, 255, 0.2)"/>
                                                </svg>
                                                <div style="position: relative; z-index: 2; display: flex; align-items: center; gap: 20px;">
                                                    <div style="font-size: 48px; filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));">${data.icon}</div>
                                                    <div style="font-size: 52px; font-weight: 700; letter-spacing: -2px; color: rgba(0, 255, 255, 0.95); text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);">${Math.round(data.distance)} <span style="font-size: 36px;">km</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div style="margin-top: 30px; text-align: center; color: #999;">
                                ${Math.round(this.stats.distance)} km au total<br>
                                √âquivalent de ${(this.stats.distance / 42.195).toFixed(1)} marathons
                            </div>
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>

                    ${this.stats.longestActivity ? `
                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">Records personnels</div>
                            <div class="trophy-showcase">
                                <div class="trophy-card">
                                    <div class="trophy-icon">üèÜ</div>
                                    <div class="trophy-label">Plus longue distance</div>
                                    <div class="trophy-time">${(this.stats.longestActivity.distance / 1000).toFixed(1)} km</div>
                                </div>
                                ${this.stats.fastestActivity && this.stats.fastestActivity.average_speed ? `
                                <div class="trophy-card">
                                    <div class="trophy-icon">‚ö°</div>
                                    <div class="trophy-label">Vitesse max</div>
                                    <div class="trophy-time">${(this.stats.fastestActivity.average_speed * 3.6).toFixed(1)} km/h</div>
                                </div>
                                ` : ''}
                                ${this.stats.highestElevation && this.stats.highestElevation.total_elevation_gain ? `
                                <div class="trophy-card">
                                    <div class="trophy-icon">‚õ∞Ô∏è</div>
                                    <div class="trophy-label">Plus gros D+</div>
                                    <div class="trophy-time">${Math.round(this.stats.highestElevation.total_elevation_gain)} m</div>
                                </div>
                                ` : ''}
                                ${this.stats.mostKudos && this.stats.mostKudos.kudos_count ? `
                                <div class="trophy-card">
                                    <div class="trophy-icon">üëç</div>
                                    <div class="trophy-label">Plus de kudos</div>
                                    <div class="trophy-time">${this.stats.mostKudos.kudos_count}</div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">Ton jour pr√©f√©r√©</div>
                            <div style="margin: 20px 0;">
                                ${dayNames.map((day, i) => {
                                    const count = this.stats.dayOfWeek[i];
                                    const width = maxDayCount > 0 ? (count / maxDayCount) * 100 : 0;
                                    return `
                                        <div class="time-bar">
                                            <div class="time-label">${day}</div>
                                            <div class="time-bar-fill">
                                                <div class="time-bar-inner" style="width: ${width}%"></div>
                                            </div>
                                            <div class="time-value">${count}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div style="margin-top: 25px; text-align: center; color: #999;">
                                Tu pr√©f√®res le <strong style="color: #fc4c02;">${dayNames[this.stats.dayOfWeek.indexOf(Math.max(...this.stats.dayOfWeek))]}</strong>
                            </div>
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">Moment de la journ√©e</div>
                            <div class="trophy-showcase">
                                <div class="trophy-card">
                                    <div class="trophy-icon">üåÖ</div>
                                    <div class="trophy-label">Matin (5h-12h)</div>
                                    <div class="trophy-time">${this.stats.timeOfDay.morning}</div>
                                </div>
                                <div class="trophy-card">
                                    <div class="trophy-icon">‚òÄÔ∏è</div>
                                    <div class="trophy-label">Apr√®s-midi</div>
                                    <div class="trophy-time">${this.stats.timeOfDay.afternoon}</div>
                                </div>
                                <div class="trophy-card">
                                    <div class="trophy-icon">üåÜ</div>
                                    <div class="trophy-label">Soir√©e</div>
                                    <div class="trophy-time">${this.stats.timeOfDay.evening}</div>
                                </div>
                                <div class="trophy-card">
                                    <div class="trophy-icon">üåô</div>
                                    <div class="trophy-label">Nuit</div>
                                    <div class="trophy-time">${this.stats.timeOfDay.night}</div>
                                </div>
                            </div>
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">Jours actifs</div>
                            <div class="stat-hero">
                                <div class="stat-value">${this.stats.days.size}</div>
                                <div class="stat-label">jours</div>
                            </div>
                            <div class="month-chart">
                                ${Object.entries(this.stats.months).map(([month, count]) => {
                                    const max = Math.max(...Object.values(this.stats.months));
                                    const width = max > 0 ? (count / max) * 100 : 0;
                                    return `
                                        <div class="month-row">
                                            <div class="month-label">${month}</div>
                                            <div class="month-bar-bg">
                                                <div class="month-bar" style="width: ${width}%">${count}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-content">
                            <div class="card-title">R√©cap de l'ann√©e</div>
                            <div class="stat-hero">
                                <div class="stat-label">Distance totale</div>
                                <div class="stat-value">${Math.round(this.stats.distance)}<span style="font-size: 40px;"> km</span></div>
                            </div>
                            
                            <div class="stat-hero">
                                <div class="stat-label">Temps total</div>
                                <div class="stat-value">${Math.round(this.stats.time)}<span style="font-size: 40px;"> h</span></div>
                            </div>
                            
                            <div class="stat-hero">
                                <div class="stat-label">D√©nivel√© positif</div>
                                <div class="stat-value">${Math.round(this.stats.elevation)}<span style="font-size: 40px;"> m</span></div>
                            </div>
                            
                            <div style="margin-top: 30px; text-align: center; color: #999;">
                                ${this.stats.prCount > 0 ? `üèÜ ${this.stats.prCount} records personnels<br>` : ''}
                                ‚ö° ${this.stats.achievementCount} troph√©es d√©bloqu√©s
                            </div>
                            
                            <div class="footer-brand">STRAVA L'ANN√âE SPORTIVE 2025 STRAVA</div>
                        </div>
                    </div>
                `;
            }

            showLoading(message, progress = null) {
                this.app.innerHTML = `
                    <div class="card">
                        <div class="card-content">
                            <div class="loading-screen">
                                <div class="spinner"></div>
                                <div class="loading-text">${message}</div>
                                ${progress !== null ? `
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div style="color: #999; margin-top: 10px;">${Math.round(progress)}%</div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            showError(message) {
                this.app.innerHTML = `
                    <div class="card">
                        <div class="card-content" style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h3 style="margin-bottom: 15px;">Erreur</h3>
                            <p style="color: #999; margin-bottom: 30px;">${message}</p>
                            <button onclick="location.reload()" class="btn">R√©essayer</button>
                        </div>
                    </div>
                `;
            }
        }

        const app = new StravaApp();
    </script>
</body>
</html>
